name: Deploy static content to Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  install-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v3에서 v4로 업데이트 권장
        with:
          fetch-depth: 0 

      - name: Setup Node
        uses: actions/setup-node@v4 # v3에서 v4로 업데이트 권장
        with:
          node-version: '20' # 명시적으로 버전을 지정하는 것이 안정적입니다

      - name: Install dependencies
        # overrides가 있어도 혹시 모를 충돌을 방지하기 위해 legacy-peer-deps를 추가하는 것이 안전합니다
        run: yarn install

      - name: Build
        # Next.js 16은 next build 시 output: 'export' 설정이 되어있으면 자동으로 out 폴더를 생성합니다
        # 만약 package.json에 export 스크립트가 따로 없다면 npm run build만 해도 됩니다
        run: npm run build
        env:
          CI: true
          DEPLORY_TARGET: gh-pages

      # Next.js 14+ 에서는 'next export' 명령어가 필요 없으므로 'npm run export' 단계는 생략 가능합니다.
      # 만약 프로젝트 설정에 따라 꼭 필요하다면 아래 줄의 주석을 해제하세요.
      # - run: npm run export

      - name: Prepare static files
        run: |
          touch out/.nojekyll
          echo -e "User-agent: *\nAllow:/" > out/robots.txt # robot.txt -> robots.txt (파일명 교정)

      - name: Generate Sitemap
        uses: cicirello/generate-sitemap@v1.9.1
        id: sitemap # id를 지정해야 아래 stats에서 참조 가능합니다
        with:
          base-url-path: https://yoonjonglyu.github.io/
          path-to-root: out

      - name: Output stats
        run: |
          echo "sitemap-path = ${{ steps.sitemap.outputs.sitemap-path }}"
          echo "url-count = ${{ steps.sitemap.outputs.url-count }}"
          echo "excluded-count = ${{ steps.sitemap.outputs.excluded-count }}"

      - name: Deploy GitHub Pages site
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: out
          branch: gh-pages
          clean: true